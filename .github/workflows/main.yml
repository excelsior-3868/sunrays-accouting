name: Supabase Nightly Backup

on:
  schedule:
    - cron: "15 16 * * *"   # 10:00 PM Nepal Time
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils

      - name: Create Database Backup (Force IPv4)
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          mkdir -p backups
          DATE=$(date +'%Y-%m-%d')

          # Extract hostname from DATABASE_URL
          HOST=$(echo "$DATABASE_URL" | sed -E 's|.*@([^:/]+).*|\1|')

          # Resolve IPv4 address only
          IPV4=$(dig +short A "$HOST" | head -n 1)

          echo "Using IPv4: $IPV4"

          PGHOSTADDR=$IPV4 pg_dump \
            "$DATABASE_URL" \
            --format=custom \
            --no-owner \
            --no-privileges \
            > backups/supabase-$DATE.dump

      - name: Commit and Push Backup
        run: |
          git config user.name "backup-bot"
          git config user.email "backup@github.com"
          git add backups/
          git commit -m "Supabase backup $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
